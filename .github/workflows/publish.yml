name: Publish
# Build and publish package to NuGet.
# Choose a main version (e.g. v5 or v6). The workflow prints matching tags and picks
# the most recent tag that starts with the chosen major (by creatordate).
on:
  workflow_dispatch:
    inputs:
      major_version:
        description: 'Select the main version to publish. The workflow will pick the most recent tag that starts with this value (e.g. v6 -> v6.2.1).'
        required: true
        type: choice
        options:
          - v5
          # - v6

jobs:
  tests:
    runs-on: ubuntu-22.04  # ubuntu-24.04 does not include mono needed for net4x tests
    outputs:
      VERSION: ${{ steps.resolve.outputs.VERSION }}
      TAG_NAME: ${{ steps.resolve.outputs.TAG_NAME }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Fetch full history and tags

    - name: Show matches for selected major and select latest tag
      id: resolve
      run: |
        set -euo pipefail

        Major='${{ github.event.inputs.major_version }}'
        echo "Selected major: $Major"

        git fetch --tags --quiet

        # Get matching tags sorted by creatordate (newest first)
        mapfile -t MATCHING < <(git for-each-ref --sort=-creatordate --format='%(refname:short)' refs/tags | grep -E "^${Major}(\.|$)" || true)

        if [ ${#MATCHING[@]} -eq 0 ]; then
          echo "::error::No tag found for major '$Major'. Showing latest tags:"
          git for-each-ref --sort=-creatordate --format='%(refname:short)' refs/tags | head -n 50
          exit 1
        fi

        echo "Matching tags (newest to oldest):"
        for t in "${MATCHING[@]}"; do
          echo " - $t"
        done

        # Choose the first (newest) matching tag
        Tag="${MATCHING[0]}"
        # Strip 'v' prefix for VERSION variable
        Version="${Tag#v}"

        echo "Selected tag: $Tag -> version: $Version"

        # Export for later steps and other jobs
        echo "TAG_NAME=$Tag" >> $GITHUB_OUTPUT
        echo "VERSION=$Version" >> $GITHUB_OUTPUT
        echo "TAG_NAME=$Tag" >> $GITHUB_ENV
        echo "VERSION=$Version" >> $GITHUB_ENV

    - name: Set Git config for line endings
      run: git config --global core.autocrlf true

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          10.0.x
          8.0.x
          6.0.x
          3.1.x

    - name: Checkout the resolved tag (detached)
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ steps.resolve.outputs.TAG_NAME }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release -p:nowarn=1591

    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity quiet

  publish:
    needs: tests
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout the same tag
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ needs.tests.outputs.TAG_NAME }}

    - name: Set Git config for line endings
      run: git config --global core.autocrlf true

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          10.0.x

    - name: Use verified version
      run: |
        echo "Using version: ${{ needs.tests.outputs.VERSION }}"
        echo "VERSION=${{ needs.tests.outputs.VERSION }}" >> $GITHUB_ENV

    - name: Set version variables
      run: |
        FileVersion=${VERSION%%-*}
        AssemblyVersion=${VERSION%%.*}.0.0
        echo "FILE_VERSION=$FileVersion" >> $GITHUB_ENV
        echo "ASSEMBLY_VERSION=$AssemblyVersion" >> $GITHUB_ENV

    - name: Restore dependencies
      run: dotnet restore

    - name: Build and pack for publishing
      run: |
        dotnet build --configuration Release Ical.Net/Ical.Net.csproj \
          -p:Version=${{env.VERSION}} \
          -p:FileVersion=${{env.FILE_VERSION}} \
          -p:AssemblyVersion=${{env.ASSEMBLY_VERSION}} \
          -p:IncludeSymbols=true \
          -p:SymbolPackageFormat=snupkg \
          -p:ContinuousIntegrationBuild=true

        dotnet pack --configuration Release Ical.Net/Ical.Net.csproj \
          -p:Version=${{env.VERSION}} \
          -p:IncludeSymbols=true \
          -p:SymbolPackageFormat=snupkg \
          --no-build

    - name: Store artifacts
      uses: actions/upload-artifact@v5
      with:
        name: ICal.Net_pkg_${{env.VERSION}}.${{github.run_number}}
        path: |
          Ical.Net/bin/Release/**/*.nupkg
          Ical.Net/bin/Release/**/*.snupkg

    - name: Push package to NuGet
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        dotnet nuget push "Ical.Net/bin/Release/Ical.Net.${{env.VERSION}}.nupkg" \
          --api-key "$NUGET_API_KEY" \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate
