name: Publish Nuget Package
# This job builds and publishes the package to NuGet.
# It depends on the included tests job to complete successfully.
# This workflow finds the most recent tag that starts with 
# the selected major version (sorted by creatordate)
# and runs the test, build and publish tasks for that tag.
on:
  workflow_dispatch:
    inputs:
      major_version:
        description: 'Select the main version to publish. The workflow will pick the most recent tag that starts with this value (e.g. v6 -> v6.2.1).'
        required: true
        type: choice
        options:
          - v5
          # - v6

jobs:
  tests:
    runs-on: ubuntu-22.04  # ubuntu-24.04 does not include mono needed for net4x tests
    outputs:
      VERSION: ${{ steps.resolve.outputs.VERSION }}
      TAG_NAME: ${{ steps.resolve.outputs.TAG_NAME }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Fetch full history and tags

    - name: Show matching major version tags and select latest by creatordate
      id: resolve
      shell: bash
      run: |
        set -euo pipefail
        # no need for chmod when using bash to run the resolver script
        bash .github/workflows/PublishResolveVersion.sh "${{ github.event.inputs.major_version }}"

    - name: Set Git config for line endings
      run: git config --global core.autocrlf true

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          10.0.x
          8.0.x
          6.0.x
          3.1.x

    - name: Checkout the resolved tag (detached)
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ steps.resolve.outputs.TAG_NAME }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release -p:nowarn=1591

    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity quiet

  publish:
    needs: tests
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout the same tag
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ needs.tests.outputs.TAG_NAME }}

    - name: Set Git config for line endings
      run: git config --global core.autocrlf true

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          10.0.x

    - name: Use verified version
      run: |
        echo "Using version: ${{ needs.tests.outputs.VERSION }}"
        echo "VERSION=${{ needs.tests.outputs.VERSION }}" >> $GITHUB_ENV

    - name: Set version variables
      run: |
        FileVersion=${VERSION%%-*}
        AssemblyVersion=${VERSION%%.*}.0.0
        echo "FILE_VERSION=$FileVersion" >> $GITHUB_ENV
        echo "ASSEMBLY_VERSION=$AssemblyVersion" >> $GITHUB_ENV

    - name: Restore dependencies
      run: dotnet restore

    - name: Build and pack for publishing
      run: |
        dotnet build --configuration Release Ical.Net/Ical.Net.csproj \
          -p:Version=${{env.VERSION}} \
          -p:FileVersion=${{env.FILE_VERSION}} \
          -p:AssemblyVersion=${{env.ASSEMBLY_VERSION}} \
          -p:IncludeSymbols=true \
          -p:SymbolPackageFormat=snupkg \
          -p:ContinuousIntegrationBuild=true

        dotnet pack --configuration Release Ical.Net/Ical.Net.csproj \
          -p:Version=${{env.VERSION}} \
          -p:IncludeSymbols=true \
          -p:SymbolPackageFormat=snupkg \
          --no-build

    - name: Store artifacts
      uses: actions/upload-artifact@v6
      with:
        name: ICal.Net_pkg_${{env.VERSION}}.${{github.run_number}}
        path: |
          Ical.Net/bin/Release/**/*.nupkg
          Ical.Net/bin/Release/**/*.snupkg

    - name: Push package to NuGet
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        dotnet nuget push "Ical.Net/bin/Release/Ical.Net.${{env.VERSION}}.nupkg" \
          --api-key "$NUGET_API_KEY" \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate
